# ===========================================
# Kinder CRM - Production Docker Compose Override
# Server: 213.109.146.167
# Domain: schoolkids.kz
# ===========================================
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ===========================================

services:
  # ===========================================
  # DATABASES - Internal only, no exposed ports
  # ===========================================
  postgres:
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-kinder_crm}
    ports: []  # Remove port exposure - internal only
    command: >
      postgres
      -c shared_buffers=256MB
      -c max_connections=200
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=2621kB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
    ports: []  # Remove port exposure - internal only
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # STORAGE - Internal only
  # ===========================================
  minio:
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
      MINIO_BROWSER_REDIRECT_URL: https://minio.schoolkids.kz
    ports: []  # Remove port exposure - internal only
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # TELEPHONY - SIP ports exposed for external trunks
  # ===========================================
  asterisk:
    environment:
      ASTERISK_ARI_PASSWORD: ${ASTERISK_ARI_PASSWORD}
    ports:
      - "5060:5060/udp"
      - "10000-10099:10000-10099/udp"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # APPLICATION - Internal only, via Caddy
  # ===========================================
  api:
    image: shribusson/kinder-api:latest
    env_file:
      - .env.production
    ports: []  # Remove port exposure - access via Caddy only
    environment:
      NODE_ENV: production
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '0.7'
        reservations:
          memory: 1G
          cpus: '0.4'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  web:
    image: shribusson/kinder-web:latest
    env_file:
      - .env.production
    ports: []  # Remove port exposure - access via Caddy only
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: https://api.schoolkids.kz
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.3'
        reservations:
          memory: 512M
          cpus: '0.2'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ===========================================
  # MONITORING - Internal only
  # ===========================================
  prometheus:
    ports: []  # Remove external access - internal only
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  grafana:
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
      GF_SERVER_ROOT_URL: https://grafana.schoolkids.kz
      GF_SECURITY_COOKIE_SECURE: "true"
      GF_SECURITY_STRICT_TRANSPORT_SECURITY: "true"
      GF_SECURITY_CONTENT_SECURITY_POLICY: "true"
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_AUTH_ANONYMOUS_ENABLED: "false"
    ports: []  # Remove external access - via Caddy only
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================
  # REVERSE PROXY - Only exposed service
  # ===========================================
  caddy:
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile.prod:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - /var/log/caddy:/var/log/caddy
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

volumes:
  caddy_data:
  caddy_config:
